<?php
/**
 * DServerMonitoringLogRoute class file.
 *
 * @author David Niaz <david.niaz@comparatio.com>
 * @copyright 2016 Comparatio USA
 */

/**
 * DServerMonitoringLogRoute sends logs messages to the Comparatio Server Monitoring System
 */

class DServerMonitoringLogRoute extends CLogRoute
{

    public static $SECURITY_KEY = array(
        -41, 15, 82, -97, 29, -106, -16, -1, -117, -69, -55, 45, 22, 105, 126, -116, -63, -57, -24, -118, -73, -107, -18, -88, 77, -125,
        -109, -26, -125, -111, -38, 68, 89, -65, -65, -45, -50, 13, 69, 96, -27, 123, 107, 30, -101, 9, 50, -4, -16, -73, -104,
        -6, -26, -123, -99, 24, 125, 115, 68, 86, -78, -127, -119, -76, -119, -81, 112, 50, -2, -3, -11, -48, 21, 107, 27, -114,
        -53, -7, -31, 101, 33, -119, 72, 106, 22, 117, 78, -120, -84, 99, -13, -58, -29, 113, 58, 36, -72, -97, 31, -94, 47,
        -19, -91, 64, 68, 91, -53, -6, -6, -23, -111, -36, 80, -105, -9, -38, 71, 101, -2, -8, -36, 83, -93, 54, 18, 97,
        -22, -108, -24, -113, -48, 18, 94, -35, 86, -81, 117, 75, 123, 110, 43, -39, 66, 76, -128, -121, -88, 74, 119, 85, -82,
        104, 13, 67, 84, -90, 67, 81, -102, 4, 24, 127, 127, -126, -114, -51, 6, 32, -92, 59, 43, -34, 91, -55, -15, -68,
        -80, 119, 88, -70, -89, 69, 93, -40, 60, 51, 4, 22, 114, 65, 74, 116, 73, 111, 47, -14, -66, -67, -75, -112, -44,
        43, -36, 78, -117, -71, -95, 44, -31, 13, 8, 41, -41, 53, 14, 72, 109, 35, -77, -122, -94, 49, -7, -28, 120, 95,
        -33, 98, -17, -83, 102, 0, 5, 27, -117, -66, -69, -87, 82, -100, 16, 87, -73, -102, 6, 37, -66, -72, -100, 19, 99,
        -4, -13, -61, -42, 50, 1, 9, 52, 9, 47, -17, -78, 127, 125, 117, 80, -18, -21, -100, 14, 74, 121, 98, -22, -96,
        39, -56, -22, -105, -11, -51, 8, 44, -29, 116, 70, 99, -15, -70, -92, 56, 31, -97, 34, -82, 109, 38, -64, -60, -37,
        76, 126, 122, 105, 17, 92, -48, 23, 120, 90, -58, -27, 126, 120, 92, -45, 36, -74, -110, -31, 106, 20, 105, 15, 79,
        -110, -33, 93, -43, 48, -11, -53, -4, -18, -86, 89, -63, -52, 1, 7, 40, -54, -10, -43, 46, -24, -115, -61, -44, 38,
        -62, -47, 26, -124, -104, -1, 0, 2, 15, 77, -123, -96, 36, -69, -84, 94, -37, 73, 113, 60, 49, -9, -40, 58, 38,
        -59, -34, 88, -67, -77, -124, -106, -14, -63, -54, -12, -56, -17, -80, 114, 62, 61, 53, 16, 85, -85, 91, -50, 11, 57,
        33, -84, 96, -25, -120, -86, 86, -75, -114, -56, -19, -93, 51, 6, 35, -79, 111, 100, -7, -33, 95, -30, 110, 45, -26,
        -128, -123, -101, 11, 62, 59, 33, -47, 28, -113, -41, 55, 26, -121, -91, 62, 56, 28, -109, -29, 118, 82, -95, 41, -44,
        40, -49, 16, 82, -97, 29, -106, -16, -75, -117, -69, -82, 107, 25, -127, -116, -64, -57, -24, -118, -74, -107, -18, -88, 76,
        -125, -109, -26, -125, -111, -39, 68, 89, -65, -65, -62, -50, 13, 70, 96, -28, 123, 108, 30, -101, 9, 49, -4, -16, -73,
        103, 7, 42, -41, 53, 14, 72, 109, 35, -76, -122, -93, 49, -7, -28, 120, 95, -33, 98, -18, -83, 101, 0, 4, 27,
        -116, -66, -69, -87, 81, -100, 16, 87, -73, -102, 6, 37, -67, -72, -99, 19, 100, -10, -46, 33, -87, 84, -87, 79, -112,
        -46, 31, -99, 22, 112, 52, 11, 59, 46, -22, -103, 2, 12, 65, 71, 104, 10, 55, 21, 110, 40, -51, 3, 20, 102,
        2, 17, 90, -60, -40, 63, 63, 66, 79, -115, -58, -32, 100, -5, -20, -98, 121, -119, -78, 124, 113, 55, 24, 122, 103,
        5, 30, -104, -4, -13, -60, -42, 50, 1, 10, 52, 9, 47, -17, -78, 127, 125, 117, 80, -108, -21, -100, 14, 75, 121,
        97, -20, -96, 39, -57, -22, -105, -11, -51, 8, 44, -29, 116, 70, 99, -15, -71, -92, 57, 31, -96, 34, -82, 109, 38,
        -64, -59, -37, 76, 126, 123, 105, 17, 92, -47, 23, 120, 90, -57, -27, 125, 120, 93, -45, 35, -74, -110, -31, 106, 20,
        104, 15, 80, -110, -33, 93, -43, 48, -12, -53, -4, -18, -85, 89, -63, -52, 1, 7, 40, -54, -10, -43, 45, -24, -115,
        -61, -45, 38, -61, -47, 25, -124, -104, -1, -1, 2, 15, 77, -122, -96, 36, -69, -8, 94, -38, 73, 114, 60, 49, -9,
        -41, 58, 38, -59, -34, 88, -67, -77, -125, -106, -13, -63, -55, -12, -56, -17, -80, 114, 62, 61, 53, 16, 85, -85, 91,
        -95, 44, -31, 103, 8, 42, -42, 53, 13, 72, 109, 35, -77, -122, -94, 49, -7, 77, 120, 95, -32, 98, -18, -83, 101,
        0, 5, 27, -116, -66, -70, -87, 81, -100, 17, 87, -73, -102, 7, 37, -66, -72, -100, 19, 100, -10, -45, 33, -87, 84,
        -88, 79, -112, -46, 30, -99, 22, 112, 52, 11, 59, 46, -21, -103, 1, 12, 64, 71, 104, 10, 54, 21, 109, 40, -52,
        3, 20, 102, 2, 17, 89, -60, -39, 63, 63, 66, 78, -115, -58, -32, 100, -5, -21, -98, 27, -119, -79, 124, 113, 55,
        23, 122, 102, 5, 29, -104, -3, -13, -60, -42, 50, 1, 9, 52, 9, 47, -17, -78, 123, 15, 117, 88, -107, -21, -101,
        14, 75, 121, 98, -20, -95, 39, -57, -22, -105, -11, -50, 8, 45, -29, 116, 70, 99, -15, -70, -92, 57, 31, -96, 34,
        -81, 109, 38, -64, -60, -37, 76, 126, 123, 105, 17, 92, -47, 23, 119, 90, -58, -27, 125, 120, 92, -45, 35, -74, -109,
        -31, 105, 20, 105, 15, 79, -110, -34, 93, -42, 48, -12, -53, -4, -18, -85, 89, -63, -52, 0, 7, 40, -54, -9, -43,
        46, -24, -116, -61, -45, 38, -61, -47, 25, -124, -103, -1, -1, 2, 14, 77, -123, -96, 37, -69, -84, 94, -38, 73, 114,
        60, 48, -9, -41, 58, 38, -59, -35, 88, -67, -77, -124, -106, -13, -63, -54, -12, -56, -17, -80, 114, 63, 61, 54, 11
    );

    public static $validToken = "510651afds56f46a0f56ad0f45as6ef4065aes0dv1sz201f560as7fr32174455632045246";

    /**
     * Saves log messages in files.
     * @param array $logs list of log messages
     */
    protected function processLogs($logs)
    {
        //MUST SET UP PARAM FOR COMPANY ID IN OUR SYSTEM BEFORE IT WILL PROPERLY BE RECEIVED!
//        $url = 'http://office.comparatio.com:8081/monitoringsystem/receiveYiiAppLogs/receiveLogs';
        $url = 'http://office.comparatio.com:8081/monitoringsystem/receiveYiiAppLogs/receiveLogs';
        $data = array(
            'data'=> $this->encrypt(
                json_encode(
                    array(
                        'cl1_id' =>Yii::app()->params['comparatioServerMonitoringClientId'],
                        'validToken' => self::$validToken,
                        'logs'=>$logs,)
                )
            ));
        $this->sendPostData($data, $url);
    }

    public static function sendPostData($_p, $remote_url) {

        try{
            $remote_url = trim($remote_url);
            $fields_string = http_build_query($_p);
            $options = array (
                'http' => array (
                    'method' => 'POST',
                    'header' => "Content-type: application/x-www-form-urlencoded\r\n".
                        "Content-Length: ".strlen($fields_string)."\r\n",
                    'content' => $fields_string,
                    'ignore_errors' => true
                )
            );
            $context  = stream_context_create($options);
            $result = file_get_contents($remote_url, false, $context);
            if($result != ""){
                DServerMonitoringLogRoute::sendPostFailEmail('Failed to POST log ' . $result);
            }
        } catch (Exception $e){

            DServerMonitoringLogRoute::sendPostFailEmail('Failed to POST log: '.$e->getMessage());
        }

    }

    static function encrypt($data) {
        if ( $data != null ) {
            $data = gzcompress($data);

            $index = 0;
            while ($index < strlen($data)) {
                $data[$index] = chr(ord($data[$index]) ^ self::$SECURITY_KEY[$index % sizeof(self::$SECURITY_KEY)]);
                $index++;
            }
            $string = "";

            for ($i=0; $i < strlen($data); $i++) {
                $hex = strtoupper(dechex(ord($data[$i])));
                if(strlen($hex) == 1) {
                    $hex = "0".$hex;
                }
                $string .= $hex;
            }

            $data = $string;
        }

        return $data;
    }

    static function sendPostFailEmail($body){
        $email = new Email();
        $email->addAddress(Yii::app()->params['adminEmail']);
        $email->subject = 'Could not send POST to Monitoring System from ' . Yii::app()->params['appFullName'];
        $email->body = "Check Runtime Logs for the Error \n\n" . $body;
        $email->send();
    }
}
